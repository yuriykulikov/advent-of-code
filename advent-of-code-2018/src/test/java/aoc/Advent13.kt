package aoc

import io.vavr.kotlin.toVavrMap
import org.assertj.core.api.Assertions.assertThat
import org.junit.Ignore
import org.junit.Test

class Advent13 {
    data class Point(val x: Int, val y: Int, val value: Char) {
        val pos by lazy { x to y }
    }

    data class CartState(
        val x: Int,
        val y: Int,
        val id: Int,
        val direction: Char,
        val intersection: Int = 1
    ) {
        val pos by lazy { x to y }
    }

    class MapMatrix(points: List<Point>) {
        private val matrix = points.groupBy { it.y }
            .mapValues { it.value.sortedBy { point -> point.x } }

        fun get(x: Int, y: Int): Point {
            return matrix[y]?.getOrNull(x) ?: Point(x, y, ' ')
        }

        fun under(cartState: CartState): Char {
            return get(cartState.x, cartState.y).value
        }

        fun dump(carts: List<CartState>) {
            println("Wagons.size = ${carts.size}")
            matrix.forEach { entry ->
                println(entry.value.joinToString(" ") { point ->
                    val char = carts.firstOrNull { cart -> cart.pos == point.pos }?.direction
                        ?: point.value
                    "$char"
                })
            }
        }

    }

    @Test
    fun `Example crash is 7,3`() {
        val (x: Int, y: Int) = Simulation(example)
            .apply { dump() }
            .firstCollision()

        assertThat("$x,$y").isEqualTo("7,3")
    }

    @Test
    fun `Real crash is 32,99 (confirmed)`() {
        val (x: Int, y: Int) = Simulation(real)
            // .apply { dump() }
            .firstCollision()
        assertThat("$x,$y").isEqualTo("32,99")
    }

    @Test
    fun `Star 2 test (confirmed)`() {
        val input = """
/>-<\
|   |
| /<+-\
| | | v
\>+</ |
  |   ^
  \<->/
        """// .trimEnd()
        val (x: Int, y: Int) = Simulation(input)
            // .apply { dump() }
            .findLastCartStanding()
        assertThat("$x,$y").isEqualTo("6,4")
    }

    @Ignore("Wrong")
    @Test
    fun `Star 2`() {
        val lastCartStanding = Simulation(real)
            // .apply { dump() }
            .findLastCartStanding()

        println(lastCartStanding)

        val (x: Int, y: Int) = lastCartStanding
        assertThat("$x,$y").isEqualTo("95,54")
    }

    data class CollisionSnapshot(val cartStates: List<CartState>, val collided: List<CartState>)

    inner class Simulation(input: String = example, private val dbg: Boolean = false) {
        private val matrix: MapMatrix
        private val cartPositions: List<CartState>

        init {
            val points = input.lines()
                .filter { !it.isBlank() }
                .mapIndexed { index, line -> index to line }
                .flatMap { (y, line) -> line.toCharArray().mapIndexed { x, char -> Point(x, y, char) } }

            matrix = MapMatrix(points.map { point ->
                when (point.value) {
                    '>', '<' -> point.copy(value = '-')
                    '^', 'v' -> point.copy(value = '|')
                    else -> point
                }
            })

            cartPositions = points
                .filter { (x, y, direction) ->
                    when (direction) {
                        '<', '^', '>', 'v' -> true
                        else -> false
                    }
                }
                .mapIndexedNotNull { index, (x, y, direction) ->
                    when (direction) {
                        '<', '^', '>', 'v' -> CartState(x, y, index, direction)
                        else -> null
                    }
                }

        }

        fun firstCollision(): Pair<Int, Int> {
            return firstCollisions(cartPositions).collided.first().pos
        }

        private fun firstCollisions(positions: List<CartState>): CollisionSnapshot {
            return generateSequence(positions) { previousPositions ->
                previousPositions.map { cartState ->
                    cartState.moveCart(matrix)
                }
            }
                .windowed(size = 2)
                .mapNotNull { (prev, next) ->
                    if (dbg) {
                        matrix.dump(next)
                    }
                    val collisions: List<CartState> = next.plus(prev)
                        .groupBy { it.pos }
                        .values
                        .filter { it.size > 1 }
                        .flatten()
                    CollisionSnapshot(next, collisions)
                }
                .filter { collision -> collision.collided.isNotEmpty() }
                .first()
        }

        /**
         * Carts all move at the same speed; they take turns moving a single step at a time. They do this based on their
         * current location: carts on the top row move first (acting from left to right), then carts on the second row
         * move (again from left to right), then carts on the third row, and so on. Once each cart has moved one step,
         * the process repeats; each of these loops is called a tick.
         *
         * What is the location of the last cart at the end of the first tick where it is the only cart left?
         */
        fun findLastCartStanding(): CartState {
            fun CartState.hasCollisions(remainingCarts: io.vavr.collection.Map<Int, CartState>): Boolean {
                return remainingCarts
                    .remove(this.id).values()
                    .any { it.pos == this.pos }
            }

            return generateSequence(cartPositions) { positions ->
                // println("Remains: ${positions.size}")
                println("Boom")
                positions
                    .sortedWith(compareBy<CartState> { it.y }.thenBy { it.x })
                    // .apply { println(joinToString { it.pos.toString() }) }
                    .fold(positions.associateBy { it.id }.toVavrMap()) { acc, next ->
                        println(next)
                        when {
                            !acc.containsKey(next.id) -> acc // already removed
                            next.moveCart(matrix).hasCollisions(acc) -> acc
                                .remove(next.id)
                                .removeValues { state -> state.pos == next.moveCart(matrix).pos }
                            else -> acc.put(next.id, next.moveCart(matrix))
                        }
                    }
                    .values()
                    .asJava()
            }
                // .onEach { println("${it.size}") }
                .first { it.size == 1 }
                .first()
        }

        fun dump() {
            matrix.dump(cartPositions)
        }
    }


    private fun CartState.moveCart(matrix: MapMatrix): CartState {
        val pos = this
        return when (pos.direction to matrix.under(pos)) {
            '^' to '/' -> pos.copy(x = pos.x + 1, direction = '>')
            '^' to '\\' -> pos.copy(x = pos.x - 1, direction = '<')
            '^' to '+' -> {
                when (pos.intersection) {
                    1 -> pos.copy(x = pos.x - 1, direction = '<', intersection = 2)
                    2 -> pos.copy(y = pos.y - 1, direction = '^', intersection = 3)
                    3 -> pos.copy(x = pos.x + 1, direction = '>', intersection = 1)
                    else -> throw RuntimeException("not possible")
                }
            }
            '^' to '|' -> pos.copy(y = pos.y - 1)

            'v' to '/' -> pos.copy(x = pos.x - 1, direction = '<')
            'v' to '\\' -> pos.copy(x = pos.x + 1, direction = '>')
            'v' to '+' -> {
                when (pos.intersection) {
                    1 -> pos.copy(x = pos.x + 1, direction = '>', intersection = 2)
                    2 -> pos.copy(y = pos.y + 1, direction = 'v', intersection = 3)
                    3 -> pos.copy(x = pos.x - 1, direction = '<', intersection = 1)
                    else -> throw RuntimeException("not possible")
                }
            }
            'v' to '|' -> pos.copy(y = pos.y + 1)

            '>' to '/' -> pos.copy(y = pos.y - 1, direction = '^')
            '>' to '\\' -> pos.copy(y = pos.y + 1, direction = 'v')
            '>' to '+' -> {
                when (pos.intersection) {
                    1 -> pos.copy(y = pos.y - 1, direction = '^', intersection = 2)
                    2 -> pos.copy(x = pos.x + 1, direction = '>', intersection = 3)
                    3 -> pos.copy(y = pos.y + 1, direction = 'v', intersection = 1)
                    else -> throw RuntimeException("not possible")
                }
            }
            '>' to '-' -> pos.copy(x = pos.x + 1)

            '<' to '/' -> pos.copy(y = pos.y + 1, direction = 'v')
            '<' to '\\' -> pos.copy(y = pos.y - 1, direction = '^')
            '<' to '+' -> {
                when (pos.intersection) {
                    1 -> pos.copy(y = pos.y + 1, direction = 'v', intersection = 2)
                    2 -> pos.copy(x = pos.x - 1, direction = '<', intersection = 3)
                    3 -> pos.copy(y = pos.y - 1, direction = '^', intersection = 1)
                    else -> throw RuntimeException("not possible")
                }
            }
            '<' to '-' -> pos.copy(x = pos.x - 1)

            else -> throw RuntimeException("$pos with '${matrix.under(pos)}' under it is not valid")
        }
    }

    val example = """
/->-\
|   |  /----\
| /-+--+-\  |
| | |  | v  |
\-+-/  \-+--/
  \------/
""".trimEnd()

    val real = """
            /-------------------------------------------------------------------------------------\               /-------------------------------\
  /---------+---\                                                                   /-------------+---------------+---\              /-----------\|
  |       /-+---+-----------------------------------------------\                 /-+-------------+---------------+---+----\         |           ||
  |       | |   |                /----------\      /------------+------------\    | |/------------+---------------+---+----+---------+------\    ||
 /+-------+-+---+----------------+----------+--\   |  /---------+------------+----+-++------------+---------------+---+----+---------+--\   |    ||
 ||       | |   |                |          |  |   |  |         |           /+----+-++------------+---------------+---+----+---------+--+---+\   ||
 ||       | |   | /--------------+----------+--+---+--+---------+-----------++----+\||            |         /-----+---+----+---\     |  |   ||   ||
 ||       | |/--+-+------\       |          |  | /-+--+---------+-----------++----++++------------+---------+-----+---+----+---+-----+--+---++---++\
 ||       | ||  | |      |       |   /------+--+-+-+--+---------+-----------++----++++------------+------\  |     |   |    |   |     |  |   ||   |||
 ||       | ||  | |      |       |/--+-----\|  | | |  |         |           ||    ||||            |      |  |     |   |    |   |     |  |   ||   |||
 ||       | ||  | |      |       ||  |     ||  | | |  |         |           ||    ||||            |      |  |     |   | /--+---+-----+--+---++---+++\
 ||       | ||  | |      |       ||  |     ||  | |/+--+---------+-----------++----++++------------+------+--+-----+---+-+--+---+-----+--+---++-\ ||||
 ||   /---+-++--+-+------+-------++--+-----++--+-+++--+---------+---\       ||    ||||            |      |  |     |   | |  |   |     \--+---++-+-/|||
 ||   |   \-++--+-+------+-------++--+-----++--+-+++--+---------/   |       ||    ||||            |      |  |     |   | |  |   |        |   || |  |||
 ||  /+-----++--+-+------+-------++--+-----++--+-+++--+-------------+-------++----++++-----------\|      |  |     |   | |  |   |        |   || |  |||
 ||  ||     ||  | |      |   /---++--+-----++--+-+++--+-------------+-------++----++++-----------++-----\|  |     |   | |  | /-+-------\|   || |  |||
 ||  ||     ||  | |   /--+---+---++--+-----++--+-+++--+-------------+-------++----++++-----------++-----++--+-----+\  | |  | | |       ||   || |  |||
 ||  || /---++--+-+---+--+---+---++--+-----++--+-+++--+-------------+-------++--\ ||||           ||     ||  |     ||  | |  | | |       ||   || |  |||
 ||  || |/--++--+-+---+--+---+---++--+-----++--+-+++-\|    /--------+-------++--+-++++-----------++->---++--+-----++--+-+--+-+-+---\   ||   || |  |||
 ||  || ||  ||  | |   |  |   |   \+--+-----+/  | ||| ||    |        |       ||  | ||||       /---++-----++--+-----++--+-+--+-+\|   |   ||   || |  |||
 \+--++-++--++--+-+---+--+---+----+--+-----+---/ ||| ||    |        |       ||/-+-++++-------+---++-----++--+-----++--+-+--+-+++---+-\ ||   || |  |||
  | /++-++--++--+-+---+--+---+----+--+-----+-----+++-++----+-------\|       ||| | ||||       |   ||     ||  |     ||  | |  | |||   | | ||   || |  |||
/-+-+++-++--++--+-+---+--+---+----+--+-----+-----+++-++----+-------++-------+++-+-++++------\|   ||     ||  |     ||  | \--+-+++---+-+-++---++-+--++/
| | ||| ||  |\--+-+---+--/   |  /-+--+---\ |     ||| ||    |       ||      /+++-+-++++------++---++-----++--+-----++--+---\| |||   | | ||   || |  ||
| | ||| ||  |   | |   |     /+--+-+--+---+-+-----+++-++----+--\  /-++------++++-+-++++------++---++-----++--+-----++--+---++-+++---+>+-++--\|| |  ||
| | ||| || /+---+-+---+-----++--+-+--+---+-+-----+++-++----+--+--+-++---->-++++-+-++++---\  ||   ||     ||  |     ||  |   || |||   | | ||  ||| |  ||
| | ||| || ||   | |   |     ||  | |  |   | |   /-+++-++----+--+--+-++------++++-+-++++---+--++---++-----++--+-----++--+---++-+++\  | | ||  ||| |  ||
| | ||| || ||   | |   |     ||  | |  |   | |   | ||| ||    |  |  | ||      |||| | ||||   |  ||   ||     ||  |     ||  |   || ||||  | | ||  ||| |  ||
|/+-+++-++-++---+-+---+-----++--+-+--+---+-+---+-+++-++----+--+--+-++-\    |||| | ||||   |  ||   ||     ||  |     ||  |   || ||||  | | ||  ||| |  ||
||| ||| || ||   |/+---+-----++--+-+--+---+-+---+-+++-++----+--+--+-++-+----++++-+-++++---+--++---++-----++--+-----++--+-\ || ||||  | | ||  ||| |  ||
||| ||| || || /-+++---+-----++--+-+-\|   | |  /+-+++-++----+--+--+-++-+----++++-+-++++---+--++---++-----++--+-----++--+\| || ||||  | | ||  ||| |  ||
||| ||| || || | |||   \-----++--+-+-++---+-+--++-+++-++----+--+--+-++-+----++++-+-++++---+--++---++-----++--+-----+/  ||| || ||||  | | ||  ||| |  ||
||| ||| || || | |||         ||  | \-++---+-/  || ||\-++----+--+--+-++-+----++/| | |||| /-+--++---++-----++--+-----+---+++-++-++++--+-+-++--+++-+--++-\
||| ||| || || | |||         ||  |/--++---+----++-++--++----+--+--+-++-+----++-+-+\|||| | |  ||   ||     ||  |     |   ||| || ||||  | | ||  ||| |  || |
||| ||| ||/++-+-+++---------++-\||  ||   |    || ||/-++----+--+--+-++-+----++-+-++++++-+-+--++---++-----++--+-----+---+++-++-++++--+-+-++--+++\|  || |
||| ||| ||||| | |||         || |||  ||   |    || ||| ||    |  |  | || |    \+-+-++++++-+-+--++---++-----++--+-----+---+++-/| ||||  | | ||  |||||  || |
||| ||| ||||| | |||       /-++-+++--++---+----++-+++-++----+--+--+-++-+-----+-+-++++++-+-+--++---++-----++--+-----+---+++--+-++++--+-+\||  |||||  || |
||| ||| ||||| | |||       | || |||  ||/--+----++-+++-++----+--+--+-++-+-----+-+-++++++-+-+--++---++-----++--+-----+---+++--+-++++--+-++++\ |||||  || |
||| ||| ||||| | |||       | || |||  |||  |    |\-+++-++----+--+--+-++-+-----+-+-++++++-+-+--++---++-----++--+-----+---+++--+-+++/  | ||||| |||||  || |
||| ||| ||||| | |||       | |\-+++--+++--+----+--+++-++----+--+--+-++-+-----+-+-++++++-+-+--++---++-----/|  |     |   |||  | |||   | ||||| |||||  || |
|||/+++-+++++-+-+++-----\ | |  |||  ||| /+----+--+++-++----+--+--+-++-+-----+-+-++++++-+-+--++---++------+--+-\   |   |||  | |||   | ||||| |||||  || |
||||||| ||||| | |||  /--+-+-+--+++--+++-++----+--+++-++----+--+--+-++-+-----+-+-++++++-+-+--++---++------+--+-+---+---+++--+-+++-\ | ||||| |||||  || |
||||||| ||||| | |||  |  | | |  |||  ||| ||    |  ||| ||  /-+--+--+-++-+-----+-+-++++++-+-+--++---++------+--+-+\  |   |||  | ||| | | ||||| |||||  || |
||||||| \++++-+-+++--+--+-+-+--+++--+++-++----+--+++-++--+-+--+--+-++-+-----+-+-/||||| v |  ||/--++------+--+-++--+---+++--+-+++-+-+-+++++\|||||  || |
|||||||  |||| | |||  |  | | |  |||  ||| ||    |  ||| ||  | |  |  | || |     | |  ||||| | |  |||  ||      |  | ||  |   |||  | \++-+-+-++/||||||||  || |
|||||||  |||| | |||  |  | | |  |||  ||| ||    |  ||| ||  | |  |  | || |     | |  ||||| | |  |||  ||      |  | ||  |   |||  |  || | | || ||||||||  || |
|||||||  |||| | |||  |  | | |  |||  ||| ||    |  ||| ||  | |  |  | || |     | |/-+++++-+-+--+++--++------+--+-++--+---+++--+--++-+-+-++\||||||||  || |
|||||||  |||| | |||  |  | | |  |||  ||| ||    |  |||/++--+-+--+--+-++-+-----+-++-+++++-+-+--+++--++------+--+-++--+---+++--+\ || | | |||||||||||  || |
|||||||  |||| | |||/-+--+-+-+--+++--+++-++----+--++++++--+-+--+--+-++-+-----+-++-+++++-+-+--+++--++------+--+-++--+---+++--++\|| | | ||||||||^||  || |
|||||||  |||| | |||| |  | | |  |||  ||| ||    |  ||||||  | |  |  | || |     | || ||||| | |  |||  ||      |  | ||  |   |||  ||||| | | |||||||||||  || |
|||||||  |||| | |||| |  | | |  ||| /+++-++----+--++++++--+-+--+--+-++-+-----+-++-+++++-+-+--+++--++------+--+-++--+\  |||  ||||| | | |||||||||||  || |
|||||||  |||| | |||| |  | | |  ||| |||| ||   /+--++++++--+-+--+--+-++-+-----+-++-+++++-+-+--+++--++-----\|  | ||  ||  ||| /+++++-+-+\|||||||||||  || |
|||||||  |||| | |||| |  | | |  ||| |||| ||   ||  ||||||  | |  |  | || |     | || ||||| | |  ||\--++-----++--+-++--++--+++-++++++-+-+++++++/|||||  || |
|||||||  |||| | |||| |  | | |  ||| |||| ||   ||  ||||||  | |  |  | || |     | || ||||| | |  ||   ||     ||  | ||  ||  ||| |||||| | ||||||| |||||  || |
|||||||  |||| | |||| |  | | |  ||| |||| ||   ||  ||||||  | \--+--+-++-+-----+-++-+++++-+-+--++---++-----++--+-++--++--+++-++++++-+-/|||||| |||||  || |
|||||||/-++++-+-++++-+--+-+-+--+++-++++-++---++-\||||||  |    |  | || |     | || ||||| | |  ||   ||     ||  | ||  ||  ||| |||||| |  |||||| |||||  || |
|||||||| |||| | |||| |  | | |  ||| ||\+-++---++-+++++++--+----+--+-++-+-----+-++-+++++-+-+--++---++-----+/  | ||  ||  ||| |||||| |  |||||| |||||  || |
|||||||| |||| | |||| |  | | \--+++-++-+-++---++-+++++++--+----/  | || |     | || |\+++-+-+--++---++-----+---+-++--++--+++-+/|||| |  |||||| |||||  || |
|||||||| |||| | |||| |  | |    |||/++-+-++---++-+++++++--+-------+-++-+-----+-++-+-+++-+-+--++---++\    |   | ||  ||  ||| | |||| |  |||||| |||||  || |
|||||||| |||| | |||| |  | |    |||||| | ||   || |||||||  | /-----+-++\|     | || | ||| | |  ||   |||    |   | ||  ||  ||| | |||| |  ^||||| |||||  || |
|||||||| |||| | |||| |  | |    |||||| | ||   \+-+++++++--+-+-----+-++++-----+-++-+-+++-+-+--++---+++----/   | ||  ||  ||| | |||| |  |||||| |||||  || |
|||||||| |||| | |||| |  | |  /-++++++-+-++----+-+++++++--+-+-----+-++++-----+\|| | ||| | |  |\---+++--------+-++--++--+++-+-++/| |  |||||| |||||  || |
|||||||| |||| | |||| |  | |  | |||||| | ||    | |||||||  | |     | ||||     |||| | ||| | |  |    |||        | ||  ^|  ||| | || | |  |||||| |||||  || |
|||||||| |||| | |||| |  | \--+-++++++-+-++----+-+++++++--+-+-----+-++++-----++++-+-+++-+-+--+----+++--------+-++--++--+++-+-++-+-+--++/||| |||||  || |
|||||||| |||| | |||| |  |    |/++++++-+-++----+-+++++++--+-+-----+-++++-----++++-+-+++-+-+--+----+++--------+-++--++--+++-+-++-+-+--++-+++\|||||  || |
||||||||/++++-+-++++-+--+----++++++++-+-++----+-+++++++--+-+-----+-++++-----++++-+-+++-+-+--+----+++--------+-++\/++--+++-+-++-+-+--++-+++++++++-\|| |
||||||||||||| | |||| |/-+----++++++++-+-++----+-+++++++--+-+-----+-++++-----++++-+-+++-+-+--+----+++--------+-++++++--+++-+-++-+-+\ || ||||||||| ||| |
|||||||\+++++-+-++++-++-+----++++++++-+-++----+-/||||||  | |     | ||||   /-++++-+-+++-+-+\ |    |||        | ||||||  ||| | || | || || ||||||||| ||| |
|||||||/+++++-+-++++-++-+----++++++++-+-++----+--++++++--+-+-----+-++++--\| |||| | ||| | || |    |||        | ||||||  ||| | || | || || ||||||||| ||| |
||||||||||||| | |||| || |    ||||||\+-+-++----+--++++++--+-+-----+-++++--++-++++-+-+++-+-++-+----+++--------+-+++++/  ||| | || | || || ||||||||| ||| |
|||||||||||||/+-++++-++-+----++++++-+-+-++----+--++++++--+-+-----+-++++--++-++++-+-+++-+-++\|    |||        | |||||   ||| | || | || || ||||||||| ||| |
||||||||||||||| |||| || |    |||||| | | ||    |  ||||||  | |     |/++++--++-++++-+-+++-+-++++----+++\   /---+-+++++---+++-+-++-+\|| || ||||||||| ||| |
||||||||||||||| |||| || |    ||||\+-+-+-++----+--++++++--+-+-----++++++--++-++++-/ ||| | ||||    ||||   |   | |||||   ||| | || |||| || ||||||||| ||| |
||||||||||||||| |||| ||/+--<-++++-+-+-+-++----+--++++++--+-+-----++++++--++-++++--\||| | ||||    ||||   |   | |||||   ||| | || |||| || ||||||||| ||| |
||\++++++++++++-/||| ||||    \+++-+-+-+-++----+--++++++--+-+-----++++++--++-+/||/-++++-+-++++----++++---+---+-+++++---+++-+-++-++++-++-+++++++++\||| |
|| ||||||||||||  |||/++++-----+++-+-+-+-++----+--++++++--+-+-----++++++--++-+-+++-++++-+-++++----++++---+---+-+++++-\ ||| | || |||| || ||||||||||||| |
|\-++++++++++++--++++++++-----+++-+-+-+-++----+--++++++--+-+-----+++++/  || | ||| |||| | ||||    ||||   |   \-+++++-+-+++-+-++-/||| || ||||||||||||| |
|/-++++++++++++--++++++++-----+++-+-+-+-++----+--++++++--+-+-----+++++---++-+-+++-++++-+-++++----++++---+----\||||| | ||| | ||  ||| || ||||||||||||| |
|| ||||||||||||  \+++++++-----+++-+-+-+-++----+--++++++--+-+-----+++++---++-+-+++-++++-+-++++----++++---+----++++++-+-++/ | ||  ||| || ||||||||||||| |
|| |||||||||\++---+++++++-----+++-+-+-+-++----+--++++++--+-+-----+++++---++-+-+++-++++-+-++++----+/||   |    |||||| | ||  | ||  ||| || ||||||||||||| |
|| ||||||||| ||  /+++++++-----+++-+-+\| ||    |  ||||||  | |     |||||   || | ||| |||| | ||||    | ||   |    ^||||| | ||  | ||  ||| || ||||||||||||| |
|| ||||||||| ||  ||||||||     ||| \-+++-++----+--++++++--+-+-----+++++---++-+-+++-++++-+-++++----+-/|   |    |||||| | ||  | ||  ||| || ||||||||||||| |
|| ||||||||| ||  ||||||||     ||\---+++-+/    |  ||||||  | |     |||||   || | |||/++++-+-++++----+--+---+----++++++-+-++--+-++--+++-++\||||||||||||| |
|| ||||||||| ||  ||||||||     ||    ||| |     |  |||||\--+-+-----+++++---++-+-++++++++-+-++++----+--+---+----++++++-+-++--+-++--+++-++++/||||||||||| |
|| ||||||||| ||  ||||||||     ||    ||| |/----+--+++++---+-+-----+++++-\ || | |||||||| | ||||    |  |   |    |||||| | ||  | ||  ||| |||| ||||||||||| |
|| ||||||||| |v  ||||||\+-----++----+++-++----+--+++++---+-+-----+++++-+-++-+-++++/||| |/++++----+--+---+----++++++-+-++--+-++-\||| |||| ||||||||||| |
|| |||\+++++-++--++++++-+-----++----+++-++----+--+++++---+-+-----+++/| | || | |||| ||| ||||||    |  |   |    |||||| | ||  | || |||| |||| ||||||||||| |
|| ||| ||||| ||  |||||| |     ||    ||| ||    |  |||||   | |     ||| | | || | |\++-+++-++++++----+--+---+----++++++-+-++--+-++-++++-+++/ ||||||||||| |
|| ||| ||||| ||  |||||| |     ||    ||| ||    |  |||||   | |     ||| | | || | | || ||| ||||||    |  |   |    |||||| | ||  | || |||| |||  ||||||||||| |
|| ||| ||||| ||  |||||| | /---++----+++-++---\|  |||||   | |     ||| | | || | | || ||\>++++++----+--+---+----++++++-+-++--+-++-++++-+++--+++/||||||| |
|| ||| ||||| ||  |||||| | |   ||    ||| ||   ||  |||||   | |     ||| | | || | | || |\-<++++++----+--+---+----++++++-+-/|  | || |||| |||  ||| ||||||| |
|| ||| ||||| ||  |||||| | |   ||    ||| ||   ||  |||||   | |     ||| | | || | | \+-+---++++++----+--+---+----++++++-+--+--+-++-++++-+++--+++-+++/||| |
||/+++-+++++-++--++++++-+-+---++-\  ||| ||   ||  |||\+---+-+-----+++-+-+-++-+-+--+-+---++++++----+--+---+----++++++-+>-+--+-/| |||| |||  ||| ||| ||| |
|\++++-+++++-++--++++++-+-+---++-+--+++-++---++--+++-+---+-+-----+++-+-+-++-+-+--+-+---++++++----+--+---+----/||||| |  |  |  | |||| |||  ||| ||| ||| |
| |||| ||||| ||  |\++++-+-+---++-+--+++-++---++--+++-+---+-+-----+++-+-+-++-+-+--+-/   ||||||    |  |  /+-----+++++-+--+--+--+-++++-+++\ ||| ||| ||| |
| |||| ||||| ||/-+-++++-+-+---++\|  ||| ||   ||  ||| |   | |     ||| | | || | |  |     ||||||    |  |  ||     ||||| |  |/-+--+-++++-++++-+++-+++-+++\|
| |||| ||||| ||| | |||| | |   ||||/-+++-++---++--+++-+---+-+----\\++-+-+-++-+-+--+-----++++++----+--+--++-----+++++-+--++-+--+-++++-++++-++/ ||| |||||
| |||| ||||| ||| | |||| | |   ||||| ||| ||   ||  \++-+---+-+----+-++-+-+-++-+-+--+-----++++++----+--+--++-----+++++-+--++-+--+-++++-++++-++--+++-++/||
| |||| ||||| ||| | |||\-+-+---+++++-+++-++---++---++-+---+-+----+-++-+-+-++-+-+--+-----++++++----+--+--++-----+++++-+--++-+--+-+++/ |||| ||  ||| || ||
| ||\+-+++++-+++-+-+++--+-+---+++++-+++-++---++---++-+---+-+----+-+/ | | ||/+-+--+-----++++++----+--+--++-----+++++-+-\|| |  | |||  |||| ||  ||| || ||
| || | ||||| ||| | |||  | |/--+++++-+++-++---++---++-+---+-+--\ | |  | | |||| |  |     ||||||   /+--+--++-----+++++-+-+++-+--+-+++--++++-++--+++-++\||
| || | ||||| ||| | |||  | ||  ||||| ||| ||   ||   || | /-+-+--+-+-+--+-+-++++-+--+-----++++++---++--+--++-----+++++-+-+++-+\ | |||  |||| ||  ||| |||||
| || | |||||/+++-+-+++--+-++--+++++-+++-++---++---++-+-+-+-+--+-+-+--+-+-++++-+--+-----++++++---++--+--++-\   ||||| | ^|| || |/+++--++++-++-\||| |||||
| || | ||||||||| | |||  | ||  ||||| ||\-++---++---++-+-+-+-+--+-+-+--+-+-++++-+--+-----++++++---++--+--++-+---+++++-+-+++-++-+++++--++++-/| |||| |||||
| || | ||||||||| \-+++--+-++--+++++-+/  ||   ||   || | | | |  | | |  | | |||\-+--+-----++++++---++--+--++-+---+++++-+-+++-++-+++++--++++--+-+/|| |||||
| || | \++++++++---+++--+-++--+++++-+---++---++---++-+-+-+-+--+-+-+--+-+-/||  |  |     ||||||   ||  |  || |   ||||| | ||| || |||||  ||||  | | || |||||
| || |  ||||||||   |||  | ||  ||||| |   ||   ||   || | | | |  | | |  | |  ||  |  |     ||||||   ||  |  || |   ||||| | ||| || |||||  ||||  | | || |||||
\-++-+--++++++++---+++--+-++--+++++-+---++---++---++-+-+-+-+--+-+-+--+-+--++--+--+-----+++++/   ||  |  || |   ||||\-+-+++-++-+++++--++++--+-+-++-+/|||
  || |  ||||||||   |||  | ||  ||||| |   ||   ||   || | | | |  | | |  | |  ||  |  |     |\+++----++--+--++-+---++++--+-+++-++-++/|v  ||||  | | || | |||
  || |  ||||||||   |||  | ||  ||||| |   ||   ||   |\-+-+-+-+--+-+-+--+-+--++--+--+-----+-+++----++--+--++-+---++++--+-+++-++-++-++--++++--+-+-/| | |||
  || |  ||||||||   |||  | ||  ||||| |   \+---++---+--+-+-+-+--+-+-+--+-+--++--+--+-----+-+++----++--+--++-+---/|||  | ||| || || ||  ||||  | |  | | |||
  || |  ||||\+++---+++--+-++--+++++-+----+---++---+--+-+-+-+--+-+-+--+-+--++--+--+-----+-+++----++--+--++-/    |||  | ||| || || ||  ||||  | |  | | |||
  || |  |||| |||   ||\--+-++--+++++-+----+--<++---+--+-+-+-+--+-+-+--+-+--++--+--+-----+-+++----++--+--++------+++--+-+++-++-++-+/  ||||  | |  | | |||
  || |  |||\-+++---++---+-++--+++++-+----+---++---+--+-+-+-+--+-+-+--+-+--++--+--+-----+-/||    \+--+--++------+++--+-+++-++-++-+---++++--+-+--+-+-/||
  || |  |||  |||   ||   | ||  ||||| |    |   ||   |  | | | |  | | |  | |  ||  |  |     |  ||     |  |  ||      |||  | ||| || |\-+---++++--+-/  | |  ||
  || |  |||  |||   ||   | ||  \++++-+----+---++---+--+-+-+-+--+-+-+--+-+--++--+--+-----+--++-----+--+--++------+++--+-+++-++-+--+---++++--/    | |  ||
  |\-+--+++--+++---++---/ ||   |||| |    |   ||   |  | |/+-+--+-+-+--+-+--++--+--+-----+\ ||     |  |  ||      |||  | ||| || |  |   ||||       | |  ||
  |  |  |||  |||   ||     ||   |||| |    |   ||   \--+-+++-+--+-+-+--+-+--++--+--+-----++-++-----+--+--++------+++--+-+++-++-+--+---++++-------/ |  ||
  |  |  |||  |||   ||     ||   |||| |    |/--++------+-+++-+--+-+-+--+>+--++--+--+-----++-++-----+--+--++------+++--+-+++-++-+--+--\||||         |  ||
  |/-+--+++--+++---++-----++---++++-+----++--++\     | ||| |  | | |  | |  ||  |  |     || ||     |  |  \+------+++--+-+++-++-+--+--++++/         |  ||
  || \--+++--+++---++-----++---++++-+----++--+++-----+-+++-+--+-+-+--+-+--++--+--+-----++-++-----/  |   |      |||  | ||| || |  |  ||||          |  ||
  ||  /-+++--+++---++-----++---++++-+----++--+++-----+-+++-+--+-+-+--+-+--++--+--+---\ || ||        |   |      ||\--+-+++-++-+--+--++++----------/  ||
  ||  | |||  |||   ||     ||   |||| |/---++--+++-----+-+++-+--+-+-+--+-+--++--+--+---+-++-++--------+---+------++---+-+++-++-+--+-\||||             ||
  ||  | |\+--+++---++-----++---++++-++---++--+++-----/ ||| |  | | |  | |  ||  |  |   | || ||        |   |      ||   | ||| || |  | |||||             ||
  ||  | | |  |||   ||     ||   |||\-++---++--+++-------+++-+--+-/ |  | |  ||  |  \---+-++-++--------+---+------++---+-+++-++-+--+-++++/             ||
  ||  | | |  |||   ||     \+---+++--++---++--/||       ||\-+--+---+--+-+--++--+------+-++-++--------+---+------/|   | ||| || |  | ||||              ||
  ||  | | |  |||   ||      |   |||  ||   ||   ||       ||  |  |   |  | |  ||  |      | \+-++--------+---+-------+---+-+++-++-+--+-++++--------------+/
  ||  | | |  |||   ||      |   |||  ||   ||   ||       ||  |  |   |  | |  ||  |      |  | ||       /+---+-------+---+-+++\|| |  | ||||              |
  ||  | | |  ||\---++------+---+/|  ||   ||   ||       ||  |  |   |  | |  ||  \------+--+-++-------++---+-------+---+-++++++-+--+-+++/              |
  ||  | | |  ||    ||     /+---+-+--++---++---++-------++--+--+---+--+-+--++---------+--+-++-------++---+--\    |   | |||||| |  | |||               |
  ||  | | |  ||    \+-----++---+-+--++---++---++-------++--+--+---+--+-+--++---------+--+-++-------++---+--+----+---+-++++++-/  | |||               |
  ||  | | |  ||     |     ||   | |  ||   ||   ||       |\--+--+---+--+-+--++---------+--/ ||       ||   |  |    |   | ||||||    | |||               |
 /++--+-+-+--++-----+-----++---+-+--++---++---++-------+--\|  |   |  | |  ||         |    ||       ||   |  |    |   | ||||||    | |||               |
 |||  | | |  |\-----+-----++---+-+--/|   ||   ||       |  ||  |   |  | |  \+---------+----/|       ||   |  |    |   | ||||||    | |||               |
 |||  | | |  |      |     ||   | |   |   |\---++-------+--++--+---+--+-+---+---------+-----+-------++---+--+----+---+-++++++----+-+/|               |
 |||  | | |  |      |     ||   | |   |   |    \+-------+--++--+---+--+-+---+---------+-----+-------++---+--+----+---+-+/||||    | | |               |
 |\+--+-+-+--+------+-----++---+-/   \---+-----+-------+--++--+---+--+-+---+---------+-----+-------++---+--+----+---+-+-++++----+-/ |               |
 | |  | | \--+------+-----++---/         |     |       |  ||  |   \--+-+---+---------+-----+-------+/   |  |    |   | | ||||    |   |               |
 | |  | |    |      \-----++-------------+-----+-------+--++--+------+-+---+---------+-----+-------+----+--+----+---/ | ||||    |   |               |
 | |  | |    |            ||             |     |       \--++--+------+-+---+---------+-----+-------+----+--+----+-----+-+++/    |   |               |
 | |  | |    |            ||             |     |          |\--+------/ |   |         |     |       |    |  |    |     | |||     |   |               |
 | |  \-+----+------------++-------------+-----+----------+---+--------+---+---------/     |       |    |  |    |     | |||     |   |               |
 | |    |    \------------++-------------+-----+----------+---+--------+---+---------------/       |    |  |    |     | \++-----+---+---------------/
 | |    |                 ||             \-----+----------+---+--------/   \-----------------------+----+--+----+-----/  ||     |   |
 | |    |                 \+-------------------+----------+---+------------------------------------+----+--/    |        ||     |   |
 | \----+------------------+-------------------/          |   |                                    \----+-------+--------/\-----+---/
 |      |                  \------------------------------+---/                                         |       |               |
 |      \-------------------------------------------------+---------------------------------------------+-------/               |
 \--------------------------------------------------------/                                             \-----------------------/
"""// .trimEnd()
}

